// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String         @id @default(uuid())
  email               String         @unique
  password            String
  firstName           String
  lastName            String
  role                String         @default("USER") // ADMIN, USER, MANAGER
  isActive            Boolean        @default(true)
  
  // Plant Assignment - User kann nur auf zugewiesene Anlage zugreifen
  assignedPlant       String?        // T208, T207, T700, T46, oder null für Admin/alle
  
  // User Approval Workflow
  approvalStatus      String         @default("PENDING") // PENDING, APPROVED, REJECTED
  approvedBy          String?
  approvedByUser      User?          @relation("UserApprovals", fields: [approvedBy], references: [id], onDelete: SetNull)
  approvedAt          DateTime?
  rejectionReason     String?
  
  // QR-Code Login (Mobile)
  qrToken             String?        @unique // Unique token für QR-Code Login
  qrTokenCreatedAt    DateTime?      // Wann wurde der QR-Code generiert
  qrTokenExpiresAt    DateTime?      // Optional: QR-Code Ablaufdatum
  qrTokenLastUsed     DateTime?      // Letzter QR-Login für Audit
  
  // Security Fields
  loginAttempts       Int            @default(0)
  lockedUntil         DateTime?
  lastLoginAttempt    DateTime?
  lastPasswordChange  DateTime?
  
  // Email & 2FA
  emailVerified       Boolean        @default(false)
  emailVerifyToken    String?
  passwordResetToken  String?
  passwordResetExpiry DateTime?
  twoFactorSecret     String?
  twoFactorEnabled    Boolean        @default(false)
  
  // Timestamps
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  
  // Relations
  refreshTokens       RefreshToken[]
  approvedUsers       User[]         @relation("UserApprovals")
  managedProjects     Project[]      @relation("ProjectManager")
  createdProjects     Project[]      @relation("ProjectCreator")
  tenderConfigurations TenderConfiguration[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@map("refresh_tokens")
}

model PasswordResetRequest {
  id          String    @id @default(uuid())
  email       String
  userId      String?
  status      String    @default("PENDING") // PENDING, RESOLVED, CANCELLED
  resolvedBy  String?
  resolvedAt  DateTime?
  note        String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("password_reset_requests")
}

model Project {
  id              String    @id @default(uuid())
  projectNumber   String    @unique // T208, T700, T207, T46
  name            String
  description     String?
  status          String    @default("PLANNED") // PLANNED, IN_PROGRESS, COMPLETED, ON_HOLD
  priority        String    @default("NORMAL") // LOW, NORMAL, HIGH, URGENT
  progress        Int       @default(0) // 0-100%
  
  // Plant Assignment - Projekt gehört zu einer Anlage
  plant           String?   // T208, T207, T700, T46 - null für anlage-übergreifend
  
  // Category - Projekttyp
  category        String    @default("MECHANICAL") // MECHANICAL, ELECTRICAL, FACILITY
  
  // Budget
  totalBudget     Float     @default(0)
  spentBudget     Float     @default(0)
  
  // Timeline
  startDate       DateTime?
  endDate         DateTime?
  
  // Manager & Creator
  managerId       String?
  manager         User?     @relation("ProjectManager", fields: [managerId], references: [id], onDelete: SetNull)
  createdBy       String
  creator         User      @relation("ProjectCreator", fields: [createdBy], references: [id])
  
  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  tasks           Task[]
  files           File[]

  @@map("projects")
}

model Task {
  id              String    @id @default(uuid())
  projectId       String
  project         Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  title           String
  description     String?
  status          String    @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED
  priority        String    @default("NORMAL") // LOW, NORMAL, HIGH, URGENT
  assignedTo      String?   // User name or ID
  
  dueDate         DateTime?
  completedAt     DateTime?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("tasks")
}

model File {
  id              String    @id @default(uuid())
  projectId       String
  project         Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  filename        String
  originalName    String
  fileType        String    // MIME type
  fileSize        Int       // in bytes
  filePath        String    // relative path in uploads folder
  
  uploadedBy      String?   // User name or ID
  uploadedAt      DateTime  @default(now())
  
  // Check-in/Check-out System
  checkedOutBy    String?   // User ID who checked out the file
  checkedOutByName String?  // User name for display
  checkedOutAt    DateTime? // When the file was checked out

  @@map("files")
}

model Action {
  id              String       @id @default(uuid())
  plant           String       // T208, T207, T700, T46
  category        String?      @default("ALLGEMEIN") // ALLGEMEIN, RIGMOVE
  discipline      String?      // MECHANIK, ELEKTRIK, ANLAGE
  title           String
  description     String?
  status          String       @default("OPEN") // OPEN, IN_PROGRESS, COMPLETED
  priority        String       @default("MEDIUM") // LOW, MEDIUM, HIGH, URGENT
  assignedTo      String?      // User name or ID
  
  dueDate         DateTime?
  completedAt     DateTime?
  
  createdBy       String?      // User name or ID
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relations
  actionFiles     ActionFile[]

  @@map("actions")
}

model ActionFile {
  id              String    @id @default(uuid())
  actionId        String
  action          Action    @relation(fields: [actionId], references: [id], onDelete: Cascade)
  
  filename        String
  originalName    String
  fileType        String    // MIME type (image/jpeg, application/pdf, etc.)
  fileSize        Int       // in bytes
  filePath        String    // relative path in uploads folder
  isPhoto         Boolean   @default(false) // true for photos, false for documents
  
  uploadedBy      String?   // User name or ID
  uploadedAt      DateTime  @default(now())

  @@map("action_files")
}

model Rig {
  id                String   @id @default(uuid())
  name              String   @unique // T700, T46, T350, etc.
  category          String   // Schwerlast, Mittlere Leistung, Kompakt
  
  // Technical Specifications
  maxDepth          Int      // in meters
  maxHookLoad       Int      // in tons
  footprint         String   // Klein, Mittel, Groß
  rotaryTorque      Int      // in Nm
  pumpPressure      Int      // in psi
  
  // Equipment Details (editierbar durch Admin)
  drawworks         String   // z.B. "2000 HP"
  mudPumps          String   // z.B. "2x 2200 HP Triplex"
  topDrive          String   // z.B. "1000 HP"
  derrickCapacity   String   // z.B. "1000 t"
  crewSize          String   // z.B. "45-50"
  mobilizationTime  String   // z.B. "30-45 Tage"
  
  // Pricing
  dayRate           String   // Tagesrate in EUR
  
  // Description
  description       String
  applications      String   // JSON array as string
  technicalSpecs    String
  
  // Audit
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  lastEditedBy      String?  // Admin user ID
  
  @@map("rigs")
}

model Equipment {
  id          String   @id @default(uuid())
  category    String   // drillPipe, tanks, power, camps, safety, mud, bop, cranes, misc
  name        String
  price       String   // Preis in EUR
  
  // Dynamic Properties (stored as JSON)
  properties  String   // JSON object with custom key-value pairs
  
  // Audit
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?  // Admin user ID
  lastEditedBy String? // Admin user ID
  
  @@map("equipment")
}

model FailureReport {
  id              String   @id @default(uuid())
  ticketNumber    String   @unique // Format: T208-202510-001
  plant           String   // T208, T207, T700, T46
  title           String
  description     String
  location        String?  // Genauer Ort auf der Anlage
  severity        String   @default("MEDIUM") // LOW, MEDIUM, HIGH, CRITICAL
  status          String   @default("REPORTED") // REPORTED, IN_REVIEW, CONVERTED_TO_ACTION, RESOLVED
  
  // Photo
  photoFilename   String?  // Dateiname des Fotos
  photoPath       String?  // Pfad zum Foto
  
  // Reporter Info
  reportedBy      String   // Email des Melders
  reportedByName  String   // Name des Melders
  
  // Conversion to Action
  convertedToActionId String? // ID der erstellten Action (falls konvertiert)
  convertedAt     DateTime?
  convertedBy     String?
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("failure_reports")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  type      String   // FAILURE_REPORT, ACTION_ASSIGNED, ACTION_COMPLETED, COMMENT_MENTION, etc.
  title     String
  message   String
  isRead    Boolean  @default(false)
  
  // Optional metadata als JSON string
  metadata  String?  // JSON: { failureReportId, actionId, projectId, etc. }
  
  // Link to notification source
  relatedId String?  // ID of related entity (failureReport, action, etc.)
  
  createdAt DateTime @default(now())
  
  @@index([userId, isRead])
  @@map("notifications")
}

model ActionComment {
  id        String   @id @default(uuid())
  actionId  String
  userId    String
  text      String
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([actionId])
  @@map("action_comments")
}

model ProjectComment {
  id        String   @id @default(uuid())
  projectId String
  userId    String
  text      String
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([projectId])
  @@map("project_comments")
}

model TenderConfiguration {
  id                String    @id @default(uuid())
  projectName       String
  clientName        String?
  location          String?
  projectDuration   String?
  selectedRig       Json      // Rig data as JSON
  selectedEquipment Json      // Equipment data as JSON
  totalPrice        Float
  isUnderContract   Boolean   @default(false)
  contractStartDate DateTime? // Contract start date for Gantt chart
  notes             String?
  
  // User who created this tender
  createdBy         String
  createdByUser     User      @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([createdBy])
  @@index([isUnderContract])
  @@map("tender_configurations")
}

// Inspection Reports (CAT III, etc.)
model InspectionReport {
  id                String                @id @default(uuid())
  reportNumber      String                @unique // Auto-generated: CAT3-YYYYMM-NNN
  
  // Basic Info
  title             String
  type              String                // CAT_III_CROWN_BLOCK, CAT_II, etc.
  plant             String                // T208, T207, T700, T46
  equipment         String                // Equipment ID/Name
  
  // Inspection Details
  inspectionDate    DateTime
  inspector         String                // Inspector name
  inspectorId       String?               // User ID
  
  // Status
  status            String                @default("DRAFT") // DRAFT, SUBMITTED, APPROVED, REJECTED
  overallResult     String?               // PASSED, FAILED, CONDITIONAL
  
  // Signatures & Approval
  inspectorSignature String?
  supervisorSignature String?
  approvedBy        String?
  approvedAt        DateTime?
  
  // Notes & Summary
  generalNotes      String?
  recommendations   String?
  
  // Relations
  sections          InspectionSection[]
  attachments       InspectionAttachment[]
  
  createdBy         String?
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  
  @@index([plant])
  @@index([type])
  @@index([status])
  @@index([inspectionDate])
  @@map("inspection_reports")
}

model InspectionSection {
  id                String                @id @default(uuid())
  reportId          String
  report            InspectionReport      @relation(fields: [reportId], references: [id], onDelete: Cascade)
  
  sectionNumber     Int                   // Order/sequence
  title             String
  description       String?
  
  items             InspectionItem[]
  
  @@index([reportId])
  @@map("inspection_sections")
}

model InspectionItem {
  id                String                @id @default(uuid())
  sectionId         String
  section           InspectionSection     @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  
  itemNumber        String                // e.g., "1.1", "2.3"
  description       String
  itemType          String                @default("CHECKBOX") // CHECKBOX, MEASUREMENT, TEXT, RATING
  
  // For different item types
  isChecked         Boolean?              // For CHECKBOX
  measurementValue  String?               // For MEASUREMENT
  measurementUnit   String?               // mm, kg, etc.
  textValue         String?               // For TEXT
  rating            Int?                  // 1-5 for RATING
  
  // Result
  result            String?               // OK, NOT_OK, N/A
  notes             String?
  
  // Reference values
  minValue          String?
  maxValue          String?
  referenceValue    String?
  
  @@index([sectionId])
  @@map("inspection_items")
}

model InspectionAttachment {
  id                String                @id @default(uuid())
  reportId          String
  report            InspectionReport      @relation(fields: [reportId], references: [id], onDelete: Cascade)
  
  filename          String
  originalName      String
  fileType          String
  fileSize          Int
  filePath          String                // URL to file
  
  uploadedBy        String?
  uploadedAt        DateTime              @default(now())
  
  @@index([reportId])
  @@map("inspection_attachments")
}

// Equipment Manual Management System (SAP IH01-inspired)
model EquipmentManual {
  id                String                @id @default(uuid())
  
  // Equipment Information
  equipmentName     String                // z.B. "Crown Block", "Mud Pump"
  equipmentNumber   String?               // SAP-like Equipment Number
  manufacturer      String?
  model             String?
  serialNumber      String?
  
  // Plant Assignment
  plant             String                // T208, T209, T210, etc.
  location          String?               // Specific location on rig
  
  // Manual Document
  manualFileName    String
  manualFilePath    String                // Cloudinary URL
  manualFileSize    Int
  uploadedAt        DateTime              @default(now())
  uploadedBy        String?
  
  // AI Extraction Status
  aiProcessed       Boolean               @default(false)
  aiProcessedAt     DateTime?
  aiExtractionData  Json?                 // Raw AI response for debugging
  
  // Manual Summary (AI-generated)
  summary           String?
  
  // Relations
  maintenanceSchedules MaintenanceSchedule[]
  spareParts           SparePart[]
  specifications       Specification[]
  
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  
  @@index([plant])
  @@index([equipmentName])
  @@map("equipment_manuals")
}

// Maintenance Schedule extracted from manual
model MaintenanceSchedule {
  id                String                @id @default(uuid())
  manualId          String
  manual            EquipmentManual       @relation(fields: [manualId], references: [id], onDelete: Cascade)
  
  taskName          String                // "Oil Change", "Filter Replacement"
  description       String?
  interval          String                // "500h", "Monthly", "Annually"
  intervalHours     Int?                  // Converted to hours for scheduling
  intervalDays      Int?                  // Converted to days for scheduling
  
  priority          String                @default("MEDIUM") // LOW, MEDIUM, HIGH, CRITICAL
  category          String?               // "Lubrication", "Inspection", "Replacement"
  
  // Required resources
  estimatedDuration String?               // "2h", "30min"
  requiredTools     String?
  safetyNotes       String?
  
  // Work Order Integration
  autoCreateWorkOrder Boolean            @default(false)
  lastWorkOrderDate   DateTime?
  nextWorkOrderDate   DateTime?
  
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  
  @@index([manualId])
  @@map("maintenance_schedules")
}

// Spare Parts extracted from manual
model SparePart {
  id                String                @id @default(uuid())
  manualId          String
  manual            EquipmentManual       @relation(fields: [manualId], references: [id], onDelete: Cascade)
  
  partNumber        String                // Manufacturer part number
  partName          String
  description       String?
  
  category          String?               // "Filter", "Bearing", "Seal", etc.
  quantity          Int?                  // Recommended stock quantity
  
  // Supplier Information
  manufacturer      String?
  supplier          String?
  supplierPartNumber String?
  
  // Pricing & Stock (optional future feature)
  unitPrice         Float?
  currency          String?               @default("USD")
  minStockLevel     Int?
  currentStock      Int?
  
  // Usage/Replacement
  replacementInterval String?            // "1000h", "Annually"
  criticalPart      Boolean               @default(false)
  
  notes             String?
  
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  
  @@index([manualId])
  @@index([partNumber])
  @@map("spare_parts")
}

// Equipment Specifications
model Specification {
  id                String                @id @default(uuid())
  manualId          String
  manual            EquipmentManual       @relation(fields: [manualId], references: [id], onDelete: Cascade)
  
  category          String                // "Dimensions", "Performance", "Electrical"
  name              String                // "Max Load", "Voltage", "Weight"
  value             String
  unit              String?               // "kg", "V", "mm"
  
  notes             String?
  
  @@index([manualId])
  @@map("specifications")
}

// Add relation to User model
// This will be added to the User model above

