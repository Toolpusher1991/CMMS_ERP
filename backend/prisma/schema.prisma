generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String                @id @default(uuid())
  email                String                @unique
  password             String
  firstName            String
  lastName             String
  role                 String                @default("USER")
  isActive             Boolean               @default(true)
  assignedPlant        String?
  approvalStatus       String                @default("PENDING")
  approvedBy           String?
  approvedAt           DateTime?
  rejectionReason      String?
  loginAttempts        Int                   @default(0)
  lockedUntil          DateTime?
  lastLoginAttempt     DateTime?
  lastPasswordChange   DateTime?
  emailVerified        Boolean               @default(false)
  emailVerifyToken     String?
  passwordResetToken   String?
  passwordResetExpiry  DateTime?
  twoFactorSecret      String?
  twoFactorEnabled     Boolean               @default(false)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  qrToken              String?               @unique
  qrTokenCreatedAt     DateTime?
  qrTokenExpiresAt     DateTime?
  qrTokenLastUsed      DateTime?
  createdProjects      Project[]             @relation("ProjectCreator")
  managedProjects      Project[]             @relation("ProjectManager")
  refreshTokens        RefreshToken[]
  tenderConfigurations TenderConfiguration[]
  approvedByUser       User?                 @relation("UserApprovals", fields: [approvedBy], references: [id])
  approvedUsers        User[]                @relation("UserApprovals")

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model PasswordResetRequest {
  id         String    @id @default(uuid())
  email      String
  userId     String?
  status     String    @default("PENDING")
  resolvedBy String?
  resolvedAt DateTime?
  note       String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@map("password_reset_requests")
}

model Project {
  id            String    @id @default(uuid())
  projectNumber String    @unique
  name          String
  description   String?
  status        String    @default("PLANNED")
  priority      String    @default("NORMAL")
  progress      Int       @default(0)
  totalBudget   Float     @default(0)
  spentBudget   Float     @default(0)
  startDate     DateTime?
  endDate       DateTime?
  managerId     String?
  createdBy     String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  plant         String?
  category      String    @default("MECHANICAL")
  flowData      String?
  rigId         String?
  files         File[]
  creator       User      @relation("ProjectCreator", fields: [createdBy], references: [id])
  manager       User?     @relation("ProjectManager", fields: [managerId], references: [id])
  rig           Rig?      @relation(fields: [rigId], references: [id], onDelete: SetNull)
  tasks         Task[]

  @@index([rigId])
  @@map("projects")
}

model Task {
  id          String    @id @default(uuid())
  projectId   String
  title       String
  description String?
  status      String    @default("PENDING")
  priority    String    @default("NORMAL")
  assignedTo  String?
  dueDate     DateTime?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("tasks")
}

model File {
  id               String    @id @default(uuid())
  projectId        String
  filename         String
  originalName     String
  fileType         String
  fileSize         Int
  filePath         String
  uploadedBy       String?
  uploadedAt       DateTime  @default(now())
  checkedOutAt     DateTime?
  checkedOutBy     String?
  checkedOutByName String?
  project          Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("files")
}

model Action {
  id          String       @id @default(uuid())
  plant       String
  category    String?      @default("ALLGEMEIN")
  title       String
  description String?
  status      String       @default("OPEN")
  priority    String       @default("MEDIUM")
  assignedTo  String?
  dueDate     DateTime?
  completedAt DateTime?
  createdBy   String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  discipline  String?
  location    String?
  rigId       String?
  actionFiles ActionFile[]
  rig         Rig?         @relation(fields: [rigId], references: [id], onDelete: SetNull)

  @@index([rigId])
  @@map("actions")
}

model ActionFile {
  id           String   @id @default(uuid())
  actionId     String
  filename     String
  originalName String
  fileType     String
  fileSize     Int
  filePath     String
  isPhoto      Boolean  @default(false)
  uploadedBy   String?
  uploadedAt   DateTime @default(now())
  action       Action   @relation(fields: [actionId], references: [id], onDelete: Cascade)

  @@map("action_files")
}

model Rig {
  id               String          @id @default(uuid())
  name             String          @unique
  category         String
  maxDepth         Int
  maxHookLoad      Int
  footprint        String
  rotaryTorque     Int
  pumpPressure     Int
  drawworks        String
  mudPumps         String
  topDrive         String
  derrickCapacity  String
  crewSize         String
  mobilizationTime String
  dayRate          String
  description      String
  applications     String
  technicalSpecs   String
  region           String?
  contractStatus   String          @default("stacked")
  location         String?
  operator         String?
  contractEndDate  String?
  certifications   String          @default("[]")
  generalInfo      String          @default("[]")
  inspections      String          @default("[]")
  issues           String          @default("[]")
  improvements     String          @default("[]")
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  lastEditedBy     String?
  actions          Action[]
  projects         Project[]
  failureReports   FailureReport[]

  @@map("rigs")
}

model Equipment {
  id           String   @id @default(uuid())
  category     String
  name         String
  price        String
  properties   String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  createdBy    String?
  lastEditedBy String?

  @@map("equipment")
}

model FailureReport {
  id                  String    @id @default(uuid())
  plant               String
  title               String
  description         String
  location            String?
  severity            String    @default("MEDIUM")
  status              String    @default("REPORTED")
  photoFilename       String?
  photoPath           String?
  reportedBy          String
  reportedByName      String
  convertedToActionId String?
  convertedAt         DateTime?
  convertedBy         String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  ticketNumber        String    @unique
  rigId               String?
  rig                 Rig?      @relation(fields: [rigId], references: [id], onDelete: SetNull)

  @@index([rigId])
  @@map("failure_reports")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  type      String
  title     String
  message   String
  isRead    Boolean  @default(false)
  metadata  String?
  relatedId String?
  createdAt DateTime @default(now())

  @@index([userId, isRead])
  @@map("notifications")
}

model ActionComment {
  id        String   @id @default(uuid())
  actionId  String
  userId    String
  text      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([actionId])
  @@map("action_comments")
}

model ProjectComment {
  id        String   @id @default(uuid())
  projectId String
  userId    String
  text      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
  @@map("project_comments")
}

model TenderConfiguration {
  id                String    @id @default(uuid())
  projectName       String
  clientName        String?
  location          String?
  projectDuration   String?
  selectedRig       Json
  selectedEquipment Json
  totalPrice        Float
  isUnderContract   Boolean   @default(false)
  notes             String?
  createdBy         String
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  contractStartDate DateTime?
  createdByUser     User      @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  @@index([createdBy])
  @@index([isUnderContract])
  @@map("tender_configurations")
}

model InspectionReport {
  id                  String                 @id @default(uuid())
  reportNumber        String                 @unique
  title               String
  type                String
  plant               String
  equipment           String
  inspectionDate      DateTime
  inspector           String
  inspectorId         String?
  status              String                 @default("DRAFT")
  overallResult       String?
  inspectorSignature  String?
  supervisorSignature String?
  approvedBy          String?
  approvedAt          DateTime?
  generalNotes        String?
  recommendations     String?
  createdBy           String?
  createdAt           DateTime               @default(now())
  updatedAt           DateTime               @updatedAt
  attachments         InspectionAttachment[]
  sections            InspectionSection[]

  @@index([plant])
  @@index([type])
  @@index([status])
  @@index([inspectionDate])
  @@map("inspection_reports")
}

model InspectionSection {
  id            String           @id @default(uuid())
  reportId      String
  sectionNumber Int
  title         String
  description   String?
  items         InspectionItem[]
  report        InspectionReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([reportId])
  @@map("inspection_sections")
}

model InspectionItem {
  id               String            @id @default(uuid())
  sectionId        String
  itemNumber       String
  description      String
  itemType         String            @default("CHECKBOX")
  isChecked        Boolean?
  measurementValue String?
  measurementUnit  String?
  textValue        String?
  rating           Int?
  result           String?
  notes            String?
  minValue         String?
  maxValue         String?
  referenceValue   String?
  section          InspectionSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  @@index([sectionId])
  @@map("inspection_items")
}

model InspectionAttachment {
  id           String           @id @default(uuid())
  reportId     String
  filename     String
  originalName String
  fileType     String
  fileSize     Int
  filePath     String
  uploadedBy   String?
  uploadedAt   DateTime         @default(now())
  report       InspectionReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([reportId])
  @@map("inspection_attachments")
}

model shift_assignments {
  id              String          @id
  plant           String
  personnelId     String
  positionId      String
  year            Int
  month           Int
  startDay        Int
  endDay          Int
  isOff           Boolean         @default(false)
  isHandover      Boolean         @default(false)
  absenceType     String?
  workDays        Int             @default(28)
  offDays         Int             @default(28)
  accommodation   String?
  notes           String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime
  shift_personnel shift_personnel @relation(fields: [personnelId], references: [id], onDelete: Cascade)
  shift_positions shift_positions @relation(fields: [positionId], references: [id], onDelete: Cascade)

  @@index([personnelId])
  @@index([plant])
  @@index([positionId])
  @@index([year, month])
}

model shift_personnel {
  id                String              @id
  plant             String
  code              String
  position          String
  isBackToBack      Boolean             @default(false)
  isActive          Boolean             @default(true)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime
  shift_assignments shift_assignments[]

  @@unique([plant, code])
  @@index([plant])
  @@index([position])
}

model shift_positions {
  id                String              @id
  plant             String
  name              String
  displayName       String
  order             Int                 @default(0)
  isActive          Boolean             @default(true)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime
  shift_assignments shift_assignments[]

  @@unique([plant, name])
  @@index([plant])
}
